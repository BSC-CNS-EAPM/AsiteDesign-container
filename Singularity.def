WARNING ARG is not supported for Singularity, and must be defined with a default to be parsed. Skipping USER
WARNING ARG is not supported for Singularity, and must be defined with a default to be parsed. Skipping PASS
Bootstrap: docker
From: ubuntu:latest
Stage: spython-base

%files
nsgrid.cpython-37m-x86_64-linux-gnu.so /opt/conda/lib/python3.7/site-packages/MDAnalysis/lib/
EDesign_p.tar.gz /home
%labels
MAINTAINER Albert Ca√±ellas <albert.canellas@bsc.es>
%post
#FROM continuumio/miniconda3

LANG=C.UTF-8
LC_ALL=C.UTF-8
PATH=/opt/conda/bin:$PATH

# Update to latest packages
apt-get update --fix-missing && \
apt-get install -y wget bzip2 ca-certificates curl git zip gcc libopenmpi-dev python3-pip -y && \
apt-get clean && \
rm -rf /var/lib/apt/lists/*

# Install PyRosetta from source
su - =$USER # USER=$USER
PASS=$PASS
PYTHONPATH=/home/EDesign_p
PATH=/home/EDesign_p:$PATH

# Set the workind directory
mkdir -p /home
cd /home

wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-py37_4.12.0-Linux-x86_64.sh -O ~/miniconda.sh && \
/bin/bash ~/miniconda.sh -b -p /opt/conda && \
rm ~/miniconda.sh && \
/opt/conda/bin/conda clean -tipsy && \
ln -s /opt/conda/etc/profile.d/conda.sh /etc/profile.d/conda.sh && \
echo ". /opt/conda/etc/profile.d/conda.sh" >> ~/.bashrc

# Install PyRosetta
conda config --add channels https://${USER}:${PASS}@conda.graylab.jhu.edu
conda install pyrosetta=2020.20+release.c522e9e

# Extra packages
pip install biotite MDAnalysis

# Install conda packages
conda install -c omnia -c conda-forge biopython cython mpi4py
rm /opt/conda/lib/python3.7/site-packages/MDAnalysis/lib/nsgrid.cpython-37m-x86_64-linux-gnu.so

#Install fftw
wget http://www.fftw.org/fftw-3.3.10.tar.gz && \
tar xfz fftw-* && \
rm fftw-3.3.10.tar.gz && \
cd fftw-3.3.10 && \
./configure && \
make && \
make install

# Install EDisgn
tar -zvf EDesign_p.tar.gz /home
mkdir -p /home/EDesign_p
cd /home/EDesign_p
python Setup.py build && \
python Setup.py install

mkdir -p /home/hostDirectory
cd /home/hostDirectory
%environment
export LANG=C.UTF-8
export LC_ALL=C.UTF-8
export PATH=/opt/conda/bin:$PATH
export PYTHONPATH=/home/EDesign_p
export PATH=/home/EDesign_p:$PATH
%runscript
cd /home/hostDirectory
exec /bin/bash "$@"
%startscript
cd /home/hostDirectory
exec /bin/bash "$@"
